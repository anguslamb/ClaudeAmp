# ClaudeAmp Developer Documentation

This file contains technical information for future development and AI-assisted coding sessions.

## Project Overview

ClaudeAmp is a 3-band EQ AudioUnit plugin built with JUCE 8.0.4. It provides real-time audio processing with bass, mid, and treble controls plus a master volume knob.

## Architecture

### Key Design Decisions

1. **JUCE Framework over native AudioUnit SDK**
   - Reason: Saves months of development time, provides cross-platform support
   - Benefits: Thread-safe parameter management, professional DSP, active community
   - Trade-off: Larger binary size, dependency on JUCE

2. **Biquad IIR filters for EQ**
   - Reason: Industry standard, minimal CPU usage, well-defined frequency response
   - Implementation: JUCE's `dsp::IIR::Filter` with `ProcessorDuplicator` for stereo
   - Alternative considered: FIR filters (rejected due to higher CPU cost)

3. **Parameter smoothing (20ms)**
   - Reason: Prevents audio clicks during parameter changes
   - Implementation: `juce::SmoothedValue<float>` with linear interpolation
   - CPU cost: Negligible (~4 extra operations per sample)

4. **Default state: 0 dB all controls**
   - Reason: Industry standard, transparent processing, safe default
   - User experience: Plugin sounds identical to bypass on first load

## File Structure

```
ClaudeAmp/
├── CMakeLists.txt              # Build configuration, plugin metadata
├── README.md                   # User documentation
├── CLAUDE.md                   # This file - developer docs
├── src/
│   ├── PluginProcessor.h       # Audio processor class definition
│   ├── PluginProcessor.cpp     # Audio DSP implementation
│   ├── PluginEditor.h          # GUI class definition
│   └── PluginEditor.cpp        # GUI implementation
└── build/                      # Generated by CMake (not in git)
    └── ClaudeAmp_artefacts/
        └── Debug/
            ├── AU/             # AudioUnit plugin
            ├── VST3/           # VST3 plugin
            └── Standalone/     # Standalone app
```

## Core Components

### PluginProcessor (Audio DSP)

**File:** `src/PluginProcessor.h` and `src/PluginProcessor.cpp`

**Responsibilities:**
- Audio processing (processBlock)
- Parameter management (APVTS)
- Filter state management
- Plugin state serialization

**Key Members:**

```cpp
// Parameter management (thread-safe)
juce::AudioProcessorValueTreeState apvts;

// Three stereo IIR filters
Filter bassFilter;    // Low-shelf @ 200 Hz
Filter midFilter;     // Peaking @ 1 kHz
Filter trebleFilter;  // High-shelf @ 5 kHz

// Parameter smoothing (prevents clicks)
juce::SmoothedValue<float> bassSmoothed;
juce::SmoothedValue<float> midSmoothed;
juce::SmoothedValue<float> trebleSmoothed;
juce::SmoothedValue<float> masterSmoothed;
```

**Critical Functions:**

1. **createParameterLayout()** - Lines 23-61
   - Defines 4 parameters with ranges and defaults
   - Parameter IDs: "bass", "mid", "treble", "master"
   - Used by APVTS for thread-safe parameter access

2. **prepareToPlay()** - Lines 132-158
   - Called when audio system initializes
   - Prepares filters with sample rate and block size
   - Resets smoothing to current parameter values
   - CRITICAL: No allocation in processBlock, do it here

3. **processBlock()** - Lines 182-241
   - Real-time audio processing (runs on audio thread)
   - Reads parameters atomically (thread-safe)
   - Updates filter coefficients
   - Processes audio through filter chain
   - Applies master gain
   - CRITICAL: No allocation, no blocking operations

4. **getStateInformation() / setStateInformation()** - Lines 257-272
   - Saves/loads plugin state as XML
   - Used for project recall and preset management
   - Automatically handles all APVTS parameters

### PluginEditor (GUI)

**File:** `src/PluginEditor.h` and `src/PluginEditor.cpp`

**Responsibilities:**
- Visual interface rendering
- User interaction (knob dragging)
- Parameter display
- Layout management

**Key Members:**

```cpp
// 4 rotary sliders (knobs)
juce::Slider bassSlider, midSlider, trebleSlider, masterSlider;

// Labels above knobs
juce::Label bassLabel, midLabel, trebleLabel, masterLabel;

// APVTS attachments (automatic two-way sync)
std::unique_ptr<juce::AudioProcessorValueTreeState::SliderAttachment> bassAttachment;
// ... (one for each parameter)
```

**Critical Functions:**

1. **Constructor** - Lines 5-66
   - Sets up all UI components
   - Configures sliders as RotaryVerticalDrag
   - Creates APVTS attachments (auto-sync to audio processor)
   - No need for manual parameter listeners

2. **paint()** - Lines 73-81
   - Draws background and title
   - Called when UI needs redrawing
   - Keep lightweight for performance

3. **resized()** - Lines 83-115
   - Positions knobs in layout
   - Called on window resize
   - Current: 4 knobs evenly spaced in 640x240 window

## Parameter Reference

### Parameter IDs and Ranges

| ID | Display Name | Range | Default | Units | Filter Type |
|----|--------------|-------|---------|-------|-------------|
| "bass" | "Bass" | -24.0 to +24.0 | 0.0 | dB | Low-shelf @ 200 Hz, Q=0.707 |
| "mid" | "Mid" | -24.0 to +24.0 | 0.0 | dB | Peaking @ 1 kHz, Q=0.7 |
| "treble" | "Treble" | -24.0 to +24.0 | 0.0 | dB | High-shelf @ 5 kHz, Q=0.707 |
| "master" | "Master" | -60.0 to +6.0 | 0.0 | dB | Gain multiplier |

### Filter Specifications

**Bass (Low-Shelf):**
- Frequency: 200 Hz (separates bass from low-mids)
- Q: 0.707 (Butterworth response, smooth transition)
- Gain range: ±24 dB
- Coefficient function: `IIR::Coefficients::makeLowShelf()`

**Mid (Peaking):**
- Frequency: 1 kHz (center of vocal range)
- Q: 0.7 (moderate bandwidth, typical for parametric EQ)
- Gain range: ±24 dB
- Coefficient function: `IIR::Coefficients::makePeakFilter()`

**Treble (High-Shelf):**
- Frequency: 5 kHz (air frequencies, presence)
- Q: 0.707 (Butterworth response)
- Gain range: ±24 dB
- Coefficient function: `IIR::Coefficients::makeHighShelf()`

## Build System

### CMakeLists.txt Configuration

**Key settings:**

```cmake
project(ClaudeAmp VERSION 1.0.0)

# JUCE location (relative path)
add_subdirectory(../JUCE ${CMAKE_BINARY_DIR}/JUCE)

# Plugin configuration
juce_add_plugin(ClaudeAmp
    COMPANY_NAME "ClaudeAudio"
    PLUGIN_MANUFACTURER_CODE Clau    # Must be unique
    PLUGIN_CODE Camp                  # Must be unique
    FORMATS AU VST3 Standalone
    COPY_PLUGIN_AFTER_BUILD TRUE     # Auto-installs to system
    ...)

# Required JUCE modules
target_link_libraries(ClaudeAmp PRIVATE
    juce::juce_audio_utils    # Audio I/O, processor wrapper
    juce::juce_dsp)           # IIR filters, ProcessSpec
```

### Build Commands

**Debug build (with symbols):**
```bash
cmake -B build -DCMAKE_BUILD_TYPE=Debug
cmake --build build --config Debug
```

**Release build (optimized):**
```bash
cmake -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build --config Release
```

**Clean rebuild:**
```bash
rm -rf build
cmake -B build -DCMAKE_BUILD_TYPE=Debug
cmake --build build
```

### Plugin Installation Paths

- **AU:** `~/Library/Audio/Plug-Ins/Components/ClaudeAmp.component`
- **VST3:** `~/Library/Audio/Plug-Ins/VST3/ClaudeAmp.vst3`
- **Standalone:** `build/ClaudeAmp_artefacts/Debug/Standalone/ClaudeAmp.app`

## Common Modification Scenarios

### 1. Adding a New Parameter

**Steps:**
1. Add parameter in `createParameterLayout()` (PluginProcessor.cpp:23-61)
2. Add SmoothedValue member in PluginProcessor.h
3. Initialize smoothing in `prepareToPlay()` (PluginProcessor.cpp:132-158)
4. Read and use parameter in `processBlock()` (PluginProcessor.cpp:182-241)
5. Add UI control in PluginEditor.h (Slider + Label + Attachment)
6. Configure UI in PluginEditor constructor (PluginEditor.cpp:5-66)
7. Position in `resized()` (PluginEditor.cpp:83-115)

**Example: Adding a "Gain" parameter:**
```cpp
// In createParameterLayout():
layout.add (std::make_unique<juce::AudioParameterFloat> (
    "gain", "Gain",
    juce::NormalisableRange<float> (0.0f, 2.0f),
    1.0f));

// In PluginProcessor.h:
juce::SmoothedValue<float> gainSmoothed;

// In prepareToPlay():
gainSmoothed.reset (sampleRate, 0.02);

// In processBlock():
auto gain = apvts.getRawParameterValue ("gain")->load();
gainSmoothed.setTargetValue (gain);
buffer.applyGain (gainSmoothed.getNextValue());
```

### 2. Changing Filter Frequencies

**File:** `src/PluginProcessor.cpp:218-233`

**Current:**
```cpp
*bassFilter.state = *juce::dsp::IIR::Coefficients<float>::makeLowShelf (
    sampleRate, 200.0f, 0.707f, bassGain);
```

**To change bass frequency to 150 Hz:**
```cpp
*bassFilter.state = *juce::dsp::IIR::Coefficients<float>::makeLowShelf (
    sampleRate, 150.0f, 0.707f, bassGain);
```

**Recommended frequencies:**
- Bass: 80-300 Hz (200 Hz is standard)
- Mid: 500-2000 Hz (1 kHz is standard)
- Treble: 3000-10000 Hz (5 kHz is standard)

### 3. Customizing UI Appearance

**Background color (PluginEditor.cpp:76):**
```cpp
g.fillAll (juce::Colours::darkgrey);  // Change to any color
```

**Knob size (PluginEditor.cpp:88-89):**
```cpp
auto knobWidth = 120;   // Increase/decrease width
auto knobHeight = 140;  // Increase/decrease height
```

**Window size (PluginEditor.cpp:9):**
```cpp
setSize (640, 240);  // Change to desired dimensions
```

### 4. Adding Presets

**Approach 1: Manual preset storage**
```cpp
// Store current state
juce::MemoryBlock presetData;
getStateInformation (presetData);
// Save to file

// Recall preset
setStateInformation (presetData.getData(), presetData.getSize());
```

**Approach 2: Use JUCE's preset mechanism**
- Implement `getCurrentProgram()`, `setCurrentProgram()`, etc.
- Store presets in ValueTree
- Add preset browser UI

### 5. Adding a Spectrum Analyzer

**Steps:**
1. Add `juce::dsp::FFT` member to PluginProcessor
2. Capture audio samples in `processBlock()`
3. Perform FFT in background thread
4. Add visualization component to PluginEditor
5. Paint frequency spectrum in `paint()`

**Required JUCE modules:**
- Already have `juce::juce_dsp` (includes FFT)

## Performance Considerations

### CPU Usage
- **Current:** < 1% on modern systems
- **Bottlenecks:** None identified
- **Optimization:** Already using efficient biquad IIR filters

### Memory Usage
- **Static memory:** < 1 KB (filter state + smoothing)
- **Dynamic allocation:** None in audio thread (all pre-allocated)

### Real-Time Safety Checklist
- ✅ No allocation in processBlock()
- ✅ No file I/O in processBlock()
- ✅ No mutex locks in processBlock()
- ✅ Atomic parameter reads (APVTS)
- ✅ Fixed-size processing (no variable allocation)

## Testing Strategy

### Manual Testing Checklist
1. ✅ Plugin loads in Logic Pro
2. ✅ GUI displays correctly
3. ✅ All knobs respond to mouse
4. ✅ Parameter values display
5. ✅ Bass control affects low frequencies
6. ✅ Mid control affects mids
7. ✅ Treble control affects highs
8. ✅ Master control affects volume
9. ✅ No audio clicks when changing parameters
10. ✅ Automation works smoothly
11. ✅ State saves/recalls correctly

### Test Tracks Recommended
- **Bass test:** Electronic music, hip-hop
- **Mid test:** Vocal tracks, acoustic guitar
- **Treble test:** Cymbals, high synths
- **Full mix:** Test all bands together

### Automated Testing
Currently no unit tests. To add:
1. Use JUCE's UnitTestRunner or Google Test
2. Test parameter ranges
3. Test filter coefficient calculation
4. Test state serialization

## Debugging

### Enable JUCE Assertions
In Debug builds, JUCE assertions are enabled. If plugin crashes:
1. Check console for assertion messages
2. Run in Xcode debugger: `Product > Run` on Standalone target

### Common Issues

**Audio thread blocking:**
- Symptom: Crackling, dropouts
- Check: Any allocation/locks in processBlock()
- Fix: Move to prepareToPlay() or background thread

**Parameter not updating:**
- Check: APVTS attachment created correctly
- Check: Parameter ID spelling matches exactly
- Check: getRawParameterValue() returns non-null

**Plugin not appearing in Logic:**
- Run: `killall -9 AudioComponentRegistrar`
- Check: Plugin codes are unique
- Check: Installation path correct

## Git Workflow

**.gitignore includes:**
```
build/              # CMake build artifacts
.DS_Store          # macOS metadata
*.user             # User-specific settings
.vscode/           # IDE settings
.idea/             # IDE settings
cmake-build-*/     # CMake build directories
```

**Commit best practices:**
- Descriptive messages
- Separate functional changes
- Test before committing
- Include Co-Authored-By for AI assistance

## Future Enhancement Ideas

1. **Variable EQ frequencies** - Add frequency knobs for each band
2. **Variable Q control** - Add Q/bandwidth knobs
3. **5 or 10-band EQ** - More granular frequency control
4. **Spectrum analyzer** - Real-time frequency visualization
5. **Preset browser** - Save/load favorite settings
6. **A/B comparison** - Quick toggle between two states
7. **Input/output meters** - Visual feedback for levels
8. **Mid/Side processing** - Separate EQ for mid and side
9. **Oversampling** - Higher quality at cost of CPU
10. **Custom knob graphics** - Use LookAndFeel for better visuals

## Dependencies

- **JUCE 8.0.4** - Core framework
- **CMake 3.22+** - Build system
- **Xcode 14+** - Compiler and SDK
- **macOS 12+** - Target OS

## References

- [JUCE Framework](https://juce.com/)
- [JUCE Documentation](https://docs.juce.com/)
- [Audio EQ Cookbook](https://webaudio.github.io/Audio-EQ-Cookbook/audio-eq-cookbook.html)
- [JUCE Forum](https://forum.juce.com/)
- [JUCE GitHub](https://github.com/juce-framework/JUCE)

## Version History

**v1.0.0** - Initial release (February 2026)
- 3-band EQ (bass, mid, treble)
- Master volume control
- Real-time processing with parameter smoothing
- AU, VST3, Standalone formats
- macOS Sequoia support (15.0)

---

*Last updated: February 14, 2026*
*Built with Claude Code - Anthropic's AI coding assistant*
